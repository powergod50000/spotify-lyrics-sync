<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Spotify Auto Lyrics + Karaoke</title>

<style>
    :root {
        --bg: #111;
        --text: #eee;
        --accent: #1db954;
    }
    body.light {
        --bg: #fafafa;
        --text: #111;
    }
    body {
        background: var(--bg);
        color: var(--text);
        font-family: sans-serif;
        padding: 20px;
        transition: background 0.3s, color 0.3s;
    }

    button {
        background: var(--accent);
        color:white;
        border:none;
        padding:10px 20px;
        border-radius:6px;
        cursor:pointer;
    }
    #lyrics span {
        display:block;
        padding:3px 0;
        font-size:18px;
        transition: color 0.2s;
    }
    .activeLine {
        color: var(--accent);
        font-weight:bold;
        font-size:20px;
    }
    #queueBox {
        background:#222;
        padding:10px;
        border-radius:6px;
        margin-top:20px;
        display:none;
    }
    body.light #queueBox {
        background:#dcdcdc;
    }

    #controls {
        margin-top:20px;
    }
    #controls button {
        margin-right:10px;
    }
</style>
</head>

<body>

<h1>Spotify Auto Lyrics + Karaoke</h1>

<button id="loginBtn">Connect Spotify</button>
<button id="themeBtn">Toggle Theme</button>
<button id="queueBtn" style="display:none;">Show Queue</button>

<div id="controls" style="display:none;">
    <button onclick="spCommand('previous')">⏮</button>
    <button onclick="spCommand('pause')">⏸</button>
    <button onclick="spCommand('play')">▶</button>
    <button onclick="spCommand('next')">⏭</button>
</div>

<h2>Lyrics</h2>
<div id="lyrics">No lyrics loaded yet.</div>

<div id="queueBox">
    <h2>Queue</h2>
    <div id="queue"></div>
</div>

<script>
/* ----------------------------------------------------
   CONFIG
---------------------------------------------------- */
const CLIENT_ID = "a079b5566fff4c44b77ed45589888e1d";
const GENIUS_TOKEN = "hHrPpZvpq0eUFbSrf7uGqYx0bs1FqHxjVCsryeiOL6Ejx4I8f0yUicUIsZ7x3W9z";
const REDIRECT_URI = "https://spotify-lyrics-sync-tawny.vercel.app/";
const SCOPES = "user-read-playback-state user-read-currently-playing user-modify-playback-state";

let timestamps = []; 
let fallbackTiming = [];
let lyricsLines = [];

/* ----------------------------------------------------
   THEME TOGGLE
---------------------------------------------------- */
document.getElementById("themeBtn").onclick = () => {
    document.body.classList.toggle("light");
    localStorage.setItem("theme", document.body.classList.contains("light") ? "light" : "dark");
};

if (localStorage.getItem("theme") === "light") {
    document.body.classList.add("light");
}

/* ----------------------------------------------------
   PKCE HELPERS
---------------------------------------------------- */
function randomStr(len) {
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
    return [...Array(len)].map(()=>chars[Math.floor(Math.random()*chars.length)]).join("");
}

async function sha256(str) {
    return crypto.subtle.digest("SHA-256", new TextEncoder().encode(str));
}

function base64url(buf) {
    return btoa(String.fromCharCode(...new Uint8Array(buf)))
        .replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
}

async function createChallenge(v) {
    return base64url(await sha256(v));
}

/* ----------------------------------------------------
   LOGIN
---------------------------------------------------- */
async function login() {
    const verifier = randomStr(128);
    localStorage.setItem("code_verifier", verifier);

    const challenge = await createChallenge(verifier);

    const params = new URLSearchParams({
        response_type: "code",
        client_id: CLIENT_ID,
        redirect_uri: REDIRECT_URI,
        scope: SCOPES,
        code_challenge_method: "S256",
        code_challenge: challenge
    });

    window.location = "https://accounts.spotify.com/authorize?" + params;
}

/* ----------------------------------------------------
   TOKEN EXCHANGE & REFRESH
---------------------------------------------------- */
async function exchangeCode(code) {
    const verifier = localStorage.getItem("code_verifier");

    const body = new URLSearchParams({
        grant_type:"authorization_code",
        code,
        redirect_uri: REDIRECT_URI,
        client_id: CLIENT_ID,
        code_verifier: verifier
    });

    const data = await fetch("https://accounts.spotify.com/api/token", {
        method:"POST",
        headers:{ "Content-Type": "application/x-www-form-urlencoded" },
        body
    }).then(r => r.json());

    saveToken(data);
}

function saveToken(data) {
    localStorage.setItem("access_token", data.access_token);
    localStorage.setItem("expires_at", Date.now() + data.expires_in * 1000);
    if (data.refresh_token) {
        localStorage.setItem("refresh_token", data.refresh_token);
    }
}

async function getToken() {
    const access = localStorage.getItem("access_token");
    const exp = Number(localStorage.getItem("expires_at"));

    if (access && Date.now() < exp) return access;

    const refresh = localStorage.getItem("refresh_token");
    if (!refresh) return null;

    const body = new URLSearchParams({
        grant_type:"refresh_token",
        refresh_token: refresh,
        client_id: CLIENT_ID
    });

    const data = await fetch("https://accounts.spotify.com/api/token", {
        method:"POST",
        headers:{ "Content-Type": "application/x-www-form-urlencoded" },
        body
    }).then(r=>r.json());

    saveToken(data);
    return data.access_token;
}

/* ----------------------------------------------------
   SPOTIFY API WRAPPER
---------------------------------------------------- */
async function sp(endpoint, method = "GET", body = null) {
    const token = await getToken();
    if (!token) return null;

    return fetch("https://api.spotify.com/v1/" + endpoint, {
        method,
        headers: {
            Authorization: "Bearer " + token,
            "Content-Type": "application/json"
        },
        body: body ? JSON.stringify(body) : null
    }).then(r => r.json());
}

/* ----------------------------------------------------
   PLAYBACK CONTROLS
---------------------------------------------------- */
async function spCommand(cmd) {
    if (cmd === "next") await sp("me/player/next", "POST");
    if (cmd === "previous") await sp("me/player/previous", "POST");
    if (cmd === "pause") await sp("me/player/pause", "PUT");
    if (cmd === "play") await sp("me/player/play", "PUT");
}

/* ----------------------------------------------------
   GENIUS LYRICS FETCH
---------------------------------------------------- */
async function fetchLyrics(title, artist) {
  const res = await fetch(
    `/api/lyrics?title=${encodeURIComponent(title)}&artist=${encodeURIComponent(artist)}`
  );

  if (!res.ok) {
    console.error("Lyrics API error", res.status);
    return "No lyrics found.";
  }

  const data = await res.json();
  return data.lyrics || "No lyrics found.";
}


    if (!search.response.hits.length) return "No lyrics found.";

    const pageUrl = search.response.hits[0].result.url;

    const scraped = await fetch(`/api/lyrics?url=${encodeURIComponent(lyricPage)}`)
        .then(r => r.json());


    return scraped.lyrics || "Lyrics unavailable.";
}

/* ----------------------------------------------------
   LOAD LYRICS
---------------------------------------------------- */
async function loadLyrics() {
    const now = await sp("me/player/currently-playing");
    if (!now || !now.item) return;

    const title = now.item.name;
    const artist = now.item.artists[0].name;

    const raw = await fetchLyrics(title, artist);
    const container = document.getElementById("lyrics");

    container.innerHTML = "";
    lyricsLines = raw.split("\n").filter(l => l.trim() !== "");

    lyricsLines.forEach((line, i) => {
        const span = document.createElement("span");
        span.textContent = line;
        container.appendChild(span);
    });

    fallbackTiming = lyricsLines.map((_, i) =>
        (now.item.duration_ms / lyricsLines.length) * i / 1000
    );
}

/* ----------------------------------------------------
   AUTO-HIGHLIGHT + AUTO-SCROLL
---------------------------------------------------- */
setInterval(async () => {
    if (!lyricsLines.length) return;

    const now = await sp("me/player/currently-playing");
    if (!now || !now.progress_ms) return;

    const current = now.progress_ms / 1000;

    let idx = 0;
    const timing = timestamps.length ? timestamps : fallbackTiming;

    for (let i = 0; i < timing.length; i++) {
        if (current >= timing[i]) idx = i;
    }

    const spans = document.querySelectorAll("#lyrics span");
    spans.forEach(s => s.classList.remove("activeLine"));
    if (spans[idx]) {
        spans[idx].classList.add("activeLine");
        spans[idx].scrollIntoView({ behavior: "smooth", block: "center" });
    }

}, 900);

/* ----------------------------------------------------
   QUEUE VIEWER
---------------------------------------------------- */
async function loadQueue() {
    const data = await sp("me/player/queue");

    const box = document.getElementById("queueBox");
    const q = document.getElementById("queue");
    q.innerHTML = "";

    data.queue.forEach(t => {
        const d = document.createElement("div");
        d.textContent = t.name + " — " + t.artists.map(a=>a.name).join(", ");
        q.appendChild(d);
    });

    box.style.display = "block";
}

/* ----------------------------------------------------
   HANDLE REDIRECT + AUTO-LOGIN
---------------------------------------------------- */
(async function() {
    const params = new URLSearchParams(window.location.search);
    const code = params.get("code");

    if (code) {
        await exchangeCode(code);
        window.history.replaceState({}, "", REDIRECT_URI);
    }

    const token = await getToken();
    if (token) {
        document.getElementById("loginBtn").style.display = "none";
        document.getElementById("queueBtn").style.display = "inline-block";
        document.getElementById("controls").style.display = "block";
        loadLyrics();
    }
})();
    
document.getElementById("loginBtn").onclick = login;
document.getElementById("queueBtn").onclick = loadQueue;

</script>

</body>
</html>


