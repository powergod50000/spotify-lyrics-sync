<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Spotify Auto Lyrics + Karaoke</title>

<style>
    :root {
        --bg: #111;
        --text: #eee;
        --accent: #1db954;
    }
    body.light {
        --bg: #fafafa;
        --text: #111;
    }
    body {
        background: var(--bg);
        color: var(--text);
        font-family: sans-serif;
        padding: 20px;
        transition: background 0.3s, color 0.3s;
    }

    button {
        background: var(--accent);
        color:white;
        border:none;
        padding:10px 20px;
        border-radius:6px;
        cursor:pointer;
    }
    #lyrics span {
        display:block;
        padding:3px 0;
        font-size:18px;
        transition: color 0.2s;
    }
    .activeLine {
        color: var(--accent);
        font-weight:bold;
        font-size:20px;
    }
    #queueBox {
        background:#222;
        padding:10px;
        border-radius:6px;
        margin-top:20px;
        display:none;
    }
    body.light #queueBox {
        background:#dcdcdc;
    }

    #controls {
        margin-top:20px;
    }
    #controls button {
        margin-right:10px;
    }
</style>
</head>

<body>

<h1>Spotify Auto Lyrics + Karaoke</h1>

<button id="loginBtn">Connect Spotify</button>
<button id="themeBtn">Toggle Theme</button>
<button id="queueBtn" style="display:none;">Show Queue</button>

<div id="controls" style="display:none;">
    <button onclick="spCommand('previous')">⏮</button>
    <button onclick="spCommand('pause')">⏸</button>
    <button onclick="spCommand('play')">▶</button>
    <button onclick="spCommand('next')">⏭</button>
</div>

<h2>Lyrics</h2>
<div id="lyrics">No lyrics loaded yet.</div>

<div id="queueBox">
    <h2>Queue</h2>
    <div id="queue"></div>
</div>

<script>
/* ----------------------------------------------------
   CONFIG
---------------------------------------------------- */
const CLIENT_ID = "a079b5566fff4c44b77ed45589888e1d";
const GENIUS_TOKEN = "hHrPpZvpq0eUFbSrf7uGqYx0bs1FqHxjVCsryeiOL6Ejx4I8f0yUicUIsZ7x3W9z";
const REDIRECT_URI = "https://spotify-lyrics-sync-tawny.vercel.app/";
const SCOPES = "user-read-playback-state user-read-currently-playing user-modify-playback-state";

let timestamps = []; 
let fallbackTiming = [];
let lyricsLines = [];

/* ----------------------------------------------------
   THEME TOGGLE
---------------------------------------------------- */
document.getElementById("themeBtn").onclick = () => {
    document.body.classList.toggle("light");
    localStorage.setItem("theme", document.body.classList.contains("light") ? "light" : "dark");
};

if (localStorage.getItem("theme") === "light") {
    document.body.classList.add("light");
}

/* ----------------------------------------------------
   PKCE HELPERS
---------------------------------------------------- */
function randomStr(len) {
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
    return [...Array(len)].map(()=>chars[Math.floor(Math.random()*chars.length)]).join("");
}

async function sha256(str) {
    return crypto.subtle.digest("SHA-256", new TextEncoder().encode(str));
}

function base64url(buf) {
    return btoa(String.fromCharCode(...new Uint8Array(buf)))
        .replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
}

async function createChallenge(v) {
    return base64url(await sha256(v));
}

/* ----------------------------------------------------
   LOGIN
---------------------------------------------------- */
async function login() {
    const verifier = randomStr(128);
    localStorage.setItem("code_verifier", verifier);

    const challenge = await createChallenge(verifier);

    const params = new URLSearchParams({
        response_type: "code",
        client_id: CLIENT_ID,
        redirect_uri: REDIRECT_URI,
        scope: SCOPES,
        code_challenge_method: "S256",
        code_challenge: challenge
    });

    window.location = "https://accounts.spotify.com/authorize?" + params;
}

/* ----------------------------------------------------
   TOKEN EXCHANGE & REFRESH
---------------------------------------------------- */
async function exchangeCode(code) {
    const verifier = localStorage.getItem("code_verifier");

    const body = new URLSearchParams({
        grant_type:"authorization_code",
        code,
        redirect_uri: REDIRECT_URI,
        client_id: CLIENT_ID,
        code_verifier: verifier
    });

    const data = await fetch("https://accounts.spotify.com/api/token", {
        method:"POST",
        headers:{ "Content-Type": "application/x-www-form-urlencoded" },
        body
    }).then(r => r.json());

    saveToken(data);
}

function saveToken(data) {
    localStorage.setItem("access_token", data.access_token);
    localStorage.setItem("expires_at", Date.now() + data.expires_in * 1000);
    if (data.refresh_token) {
        localStorage.setItem("refresh_token", data.refresh_token);
    }
}

async function getToken() {
    const access = localStorage.getItem("access_token");
    const exp = Number(localStorage.getItem("expires_at"));

    if (access && Date.now() < exp) return access;

    const refresh = localStorage.getItem("refresh_token");
    if (!refresh) return null;

    const body = new URLSearchParams({
        grant_type:"refresh_token",
        refresh_token: refresh,
        client_id: CLIENT_ID
    });

    const data = await fetch("https://accounts.spotify.com/api/token", {
        method:"POST",
        headers:{ "Content-Type": "application/x-www-form-urlencoded" },
        body
    }).then(r=>r.json());

    saveToken(data);
    return data.access_token;
}

/* ----------------------------------------------------
   SPOTIFY API WRAPPER
---------------------------------------------------- */
async function sp(endpoint, method = "GET", body = null) {
    const token = await getToken();
    if (!token) return null;

    return fetch("https://api.spotify.com/v1/" + endpoint, {
        method,
        headers: {
            Authorization: "Bearer " + token,
            "Content-Type": "appli
